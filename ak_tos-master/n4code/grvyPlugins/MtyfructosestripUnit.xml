<?xml version="1.0" encoding="UTF-8"?>
<argo:snx xmlns:argo="http://www.navis.com/argo" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.navis.com/argo snx.xsd">
<digital-asset id="MtyFructoseStripUnit" short-description="MTY FRUCTOSE Process" groovy-code="import com.navis.apex.business.model.GroovyInjectionBase&#xA;import com.navis.argo.business.atoms.EventEnum&#xA;import com.navis.argo.business.atoms.LocTypeEnum&#xA;import com.navis.argo.business.model.CarrierVisit&#xA;import com.navis.argo.business.atoms.BizRoleEnum&#xA;import com.navis.argo.business.atoms.UnitCategoryEnum&#xA;import com.navis.orders.business.eqorders.Booking&#xA;import com.navis.orders.business.eqorders.EquipmentOrderManagerPea&#xA;import com.navis.argo.business.reference.*&#xA;import com.navis.inventory.business.units.*&#xA;import com.navis.framework.util.BizViolation&#xA;import com.navis.argo.business.api.GroovyApi&#xA;import com.navis.services.business.event.GroovyEvent&#xA;&#xA;public class MtyFructoseStripUnit {&#xA;    public String mtyFrucroseProc(Object unit) {&#xA;&#xA;&#xA;&#x9;def ctrId = unit.getFieldValue(&quot;unitId&quot;);&#xA;&#x9;def bl_nbr = unit.getFieldValue(&quot;unitGoods.gdsBlNbr&quot;);&#xA;&#x9;def unitNotes = unit.getFieldValue(&quot;unitRemark&quot;);&#xA;&#x9;def dobCvId = unit.getFieldValue(&quot;unitRouting.rtgDeclaredCv.cvId&quot;);&#xA;try {&#xA;    //def recorder = (String) inParameters.get(&quot;recorder&quot;);&#xA;&#xA;// find booking&#xA;&#x9;def injBase = new GroovyInjectionBase();&#xA;&#x9;def facility = injBase.getFacility();&#xA;&#x9;def cv = CarrierVisit.findVesselVisit( facility, dobCvId);&#xA;&#x9;if ( cv == null) {&#xA;&#x9;&#x9;return &quot;ERR_MTY_F_001. Could not find the carrier visit: &quot; + dobCvId;&#xA;&#x9;}&#xA;&#xA;&#x9;def bizScope = ScopedBizUnit.findScopedBizUnit( &quot;MAT&quot;, BizRoleEnum.LINEOP);&#xA;&#x9;if ( bizScope == null) {&#xA;&#x9;&#x9;&#x9;return &quot;ERR_MTY_F_002. Could not find the business unit: MAT&quot;;&#xA;&#x9;}&#xA;&#xA;&#x9;def booking = Booking.findBookingByUniquenessCriteria( bl_nbr, bizScope, cv);&#xA;&#x9;if ( booking == null) {&#xA;&#x9;&#x9;&#x9;return &quot;ERR_MTY_F_003. Could not find booking: &quot; + bl_nbr;&#xA;&#x9;}&#xA;&#xA;&#xA;&#x9;// check if the commodity id is ok.&#xA;&#x9;if ( unit.isStorageEmpty())&#xA;&#x9;&#x9;return (new StringBuilder()).append(&quot;ERR_GVY_MTY_F_004. Could not STRIP EMPTY unit: &quot;).append(ctrId).toString();&#xA;&#xA;&#x9;// find the facilityVisit&#xA;&#x9;def fullUfv = unit.getUfvForFacilityNewest(facility);&#xA;&#x9;if ( fullUfv == null) {&#xA;&#x9;&#x9;return &quot;ERR_MTY_F_005. Could not find facility visit for unit:&quot; + ctrId;&#xA;&#x9;}&#xA;&#xA;&#x9;// Strp it, and get back the new full UFV and Unit&#xA;&#x9;def strippedUfv = null;&#xA;&#x9;try {&#xA;&#x9;&#x9;strippedUfv = injBase.stripUfvAndRecordEvent( fullUfv, null, &quot;Gvy MTY Fructose proc&quot;);&#xA;&#x9;} catch ( Exception stripEx) {&#xA;&#x9;&#x9;return &quot;ERR_GVY_MTY_F_006. Could not STRIP unit: &quot; + ctrId;&#xA;&#x9;}&#xA;&#x9;def strippedUnit = strippedUfv.getUfvUnit();&#xA;&#xA;&#x9;if ( strippedUnit == null)&#xA;&#x9;&#x9;return &quot;ERR_GVY_MTY_F_007. Could not get UFV unit after STRIP unit: &quot; + ctrId;&#xA;&#xA;&#x9;// set CATEGORY&#xA;&#x9;strippedUnit.setUnitCategory(UnitCategoryEnum.EXPORT);&#xA;&#x9;// set BOOKING NUM and Carrier info&#xA;&#x9;strippedUnit.setFieldValue(&quot;unitGoods.gdsBlNbr&quot;, bl_nbr);&#xA;&#x9;strippedUnit.setUnitRemark( unitNotes);&#xA;&#xA;def api = new GroovyApi();&#xA;def orderItemVal;&#xA;&#xA;def ue = strippedUnit.getUnitPrimaryUe();&#xA;if (ue.getUeDepartureOrderItem() != null) {&#xA;&#x9;orderItemVal = &quot;OrderItem is not null&quot;;&#xA;   ue.getUeDepartureOrderItem().getEqboiOrder().setEqboNbr(bl_nbr);&#xA;} else {&#xA;&#x9;orderItemVal = &quot;OrderItem is null&quot;;&#xA;}&#xA;&#xA;&#x9;def eqoMgr = new EquipmentOrderManagerPea();&#xA;&#x9;eqoMgr.assignExportBookingToUnit( booking, strippedUnit);&#xA;&#x9;//strippedUnit.recordUnitEvent(EventEnum.UNIT_STRIP, null, &quot;Stripped by MtyFructoseStripUnit&quot;);&#xA;&#xA;&#xA;&#x9;GroovyEvent event = new GroovyEvent( null, strippedUnit);&#xA;&#x9;event.postNewEvent( &quot;FRUCTOSE_LOAD&quot;, unitNotes);&#xA;&#xA;/*&#xA;def routing = strippedUnit.getUnitRouting();&#xA;if ( routing == null)&#xA;&#x9;routing = new Routing();&#xA;def rdcv = booking.getEqoVesselVisit();&#xA;            routing.setRtgDeclaredCv( rdcv);&#xA;&#xA;            def  pod1 = booking.getEqoPod1();&#xA;            routing.setRtgPOD1( pod1);&#xA;&#xA;            def pol = booking.getEqoPol();&#xA;            routing.setRtgPOL( pol);&#xA;&#xA;&#xA;            strippedUnit.updateUnitRouting(routing);&#xA;            strippedUnit.getUnitGoods().setGoodsDestination( booking.getEqoDestination());&#xA;*/&#xA;&#x9;// Record an event&#xA;&#x9;return &quot;done via Groovy, &quot; + orderItemVal;&#xA;&#xA;} catch ( Exception ex) {&#xA;&#x9;return ((new StringBuilder()).append(&quot;ERR_GVY_MTY_F_999. Could not fire MTY FRUCTOSE event on unit: &quot;).append(ctrId).append(&quot;\nSN4 Exception: &quot;).append(ex.toString()).toString());&#xA;}&#xA;}&#xA;}&#xA;&#xA;" />
</argo:snx>

